name: Build and Publish SDKs

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ============================
      # 1. iOS BUILD (.xcframework)
      # ============================
      - name: Build iOS SwiftPM XCFramework
        working-directory: ios
        run: |
          set -e
          swift build -c release --product AppFig
          mkdir -p ../dist/ios
          swift package compute-checksum Sources/AppFig/AppFigiOSSDK.swift > ../dist/ios/checksum.txt
          xcodebuild -create-xcframework \
            -framework .build/apple/Products/Release/AppFig.framework \
            -output ../dist/ios/AppFig.xcframework

      # ============================
      # 2. Android BUILD (AAR)
      # ============================
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build Android AAR
        working-directory: android/project
        run: |
          set -e
          chmod +x ./gradlew
          ./gradlew clean assembleRelease
          mkdir -p ../../dist/android
          cp ./build/outputs/aar/project-release.aar ../../dist/android/AppFigAndroidSDK.aar

      # ============================
      # 3. Unity BUILD (copy DLL)
      # ============================
      - name: Copy Unity DLL
        run: |
          mkdir -p dist/unity
          cp unity/AppFigUnitySDK.dll dist/unity/

      # ============================
      # 4. React (single-file)
      # ============================
      - name: Build React SDK
        working-directory: react
        run: |
          set -e
          mkdir -p ../dist/react
          cp AppFigReactSDK.ts ../dist/react/AppFigReactSDK.ts

      # ============================
      # 5. Upload artifacts
      # ============================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: appfig-sdks
          path: dist/
